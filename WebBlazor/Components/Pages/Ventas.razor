@page "/ventas"
@using Data.Models
@using Data.Repository.Common
@inject IArticuloRepository ArticuloRepo
@inject NotificationService NotificationService

<RadzenText TextStyle="TextStyle.H3">Gestión de Ventas</RadzenText>

<RadzenCard class="my-4">
        <RadzenButton Text="Generar 10 Ventas"
                      ButtonStyle="ButtonStyle.Warning"
                      Click="@(() => ProcesarVentas(10))"
                      Disabled="@isProcessing" />

        <RadzenButton Text="Refrescar Tabla"
                      ButtonStyle="ButtonStyle.Secondary"
                      Click="@CargarVentas"
                      Disabled="@isProcessing" />
</RadzenCard>

<RadzenDataGrid AllowFiltering="true"
                AllowColumnResize="true"
                AllowAlternatingRows="false"
                FilterMode="FilterMode.Advanced"
                AllowSorting="true"
                PageSize="10"
                AllowPaging="true"
                PagerHorizontalAlign="HorizontalAlign.Left"
                ShowPagingSummary="true"
                @ref="gridVentas"
                Data="@ventas"
                TItem="Venta"
                ColumnWidth="300px"
                EmptyText="No hay ventas registradas.">

    <Template Context="venta">
        <RadzenTabs RenderMode="TabRenderMode.Client">
            <Tabs>
                    <RadzenDataGrid Data="@venta.Detalles" TItem="VentaDetalle" AllowPaging="true" PageSize="5">
                        <Columns>
                            <RadzenDataGridColumn TItem="VentaDetalle" Property="ArticuloId" Title="ID Art." Width="70px" />
                            <RadzenDataGridColumn TItem="VentaDetalle" Property="Cantidad" Title="Cant." Width="80px" />
                            <RadzenDataGridColumn TItem="VentaDetalle" Property="PrecioAplicado" Title="Precio Unit.">
                                <Template Context="detalle">
                                    @detalle.PrecioAplicado.ToString("C2")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="VentaDetalle" Title="Subtotal">
                                <Template Context="detalle">
                                    @((detalle.PrecioAplicado * detalle.Cantidad).ToString("C2"))
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
            </Tabs>
        </RadzenTabs>
    </Template>

    <Columns>
        <RadzenDataGridColumn TItem="Venta" Property="Id" Title="ID Venta" Width="80px" />
        <RadzenDataGridColumn TItem="Venta" Property="ClienteId" Title="ID Cliente" Width="100px" />
        <RadzenDataGridColumn TItem="Venta" Property="Fecha" Title="Fecha" Width="200px">
            <Template Context="venta">
                @venta.Fecha.ToString("dd/MM/yyyy")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Venta" Title="Total Artículos" Width="120px">
            <Template Context="venta">
                @venta.Detalles.Count
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Venta" Title="Importe Total" Width="150px">
            <Template Context="venta">
                @venta.Detalles.Sum(d => d.PrecioAplicado * d.Cantidad).ToString("C2")
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    RadzenDataGrid<Venta> gridVentas;
    IEnumerable<Venta> ventas;
    bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarVentas();
    }

    async Task CargarVentas()
    {
        ventas = await ArticuloRepo.GetVentasAsync();

        if (gridVentas != null)
        {
            await gridVentas.Reload();
        }
        StateHasChanged();
    }

    async Task ProcesarVentas(int cantidad)
    {
        isProcessing = true;
        try
        {
            await ArticuloRepo.GenerarVentasMasivasAsync(cantidad);
            await CargarVentas();
            NotificationService.Notify(NotificationSeverity.Success, "Éxito", $"Generadas {cantidad} ventas");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }
}