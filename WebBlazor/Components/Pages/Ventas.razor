@page "/ventas"
@using Data.Models
@using Data.Repository.Common
@inject IArticuloRepository ArticuloRepo
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenText TextStyle="TextStyle.H3">Gestión de Ventas</RadzenText>


<RadzenButton Text="Generar ventas"
              ButtonStyle="ButtonStyle.Warning"
              Click="@(() => ProcesarVentas(10))"/>

<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center">
    @if (isLoading)
    {
        <RadzenText>Procesando registros...</RadzenText>
    }
</RadzenStack>

<RadzenDataGrid AllowSorting="true"
                AllowColumnResize="true"
                PageSize="10"
                AllowPaging="true"
                PagerHorizontalAlign="HorizontalAlign.Left"
                ShowPagingSummary="true"
                @ref="gridVentas"
                Data="@ventas"
                TItem="Venta"
                ColumnWidth="300px"
                EmptyText="No hay ventas registradas.">

    <Template Context="venta">
        <RadzenTabs RenderMode="TabRenderMode.Client">
            <Tabs>
                    <RadzenDataGrid Data="@venta.Detalles" TItem="VentaDetalle" AllowPaging="true" PageSize="5">
                        <Columns>
                            <RadzenDataGridColumn TItem="VentaDetalle" Property="ArticuloId" Title="ID Art." Width="70px" />
                            <RadzenDataGridColumn TItem="VentaDetalle" Property="Cantidad" Title="Cant." Width="80px" />
                            <RadzenDataGridColumn TItem="VentaDetalle" Property="PrecioAplicado" Title="Precio Unit.">
                                <Template Context="detalle">
                                    @detalle.PrecioAplicado.ToString("C2")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="VentaDetalle" Title="Subtotal">
                                <Template Context="detalle">
                                    @((detalle.PrecioAplicado * detalle.Cantidad).ToString("C2"))
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
            </Tabs>
        </RadzenTabs>
    </Template>

    <Columns>
        <RadzenDataGridColumn TItem="Venta" Property="Id" Title="ID Venta" Width="80px" />
        <RadzenDataGridColumn TItem="Venta" Property="ClienteId" Title="ID Cliente" Width="100px" />
        <RadzenDataGridColumn TItem="Venta" Property="Fecha" Title="Fecha" Width="200px">
            <Template Context="venta">
                @venta.Fecha.ToString("dd/MM/yyyy")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Venta" Title="Total Artículos" Width="120px">
            <Template Context="venta">
                @(venta.Detalles?.Sum(d => d.Cantidad) ?? 0)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Venta" Title="Importe Total" Width="150px">
            <Template Context="venta">
                @{
                    var total = venta.Detalles?.Sum(d => d.Cantidad * d.PrecioAplicado) ?? 0;
                    @total.ToString("C2")
                }
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    RadzenDataGrid<Venta> gridVentas;
    IEnumerable<Venta> ventas;
    bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarVentas();
    }

    async Task CargarVentas()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            ventas = await ArticuloRepo.GetVentasAsync();

            if (gridVentas != null)
            {
                await gridVentas.Reload();
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    async Task ProcesarVentas(int cantidad)
    {
        var confirm = await DialogService.Confirm($"Quieres generar {cantidad} ventas?", "Generador");
        if (confirm == true)
        {
            isLoading = true;
            StateHasChanged();

            try
            {
                await ArticuloRepo.GenerarVentasMasivasAsync(cantidad);
                await CargarVentas();

                NotificationService.Notify(NotificationSeverity.Success, "Éxito", $"Generadas {cantidad} ventas");
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

}