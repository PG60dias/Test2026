@using Data.DTOs
@using Data.Modelo
@using Data.Models
@using Data.Repository.Common
@using Domain.Services
@inject ClienteService ClienteService
@inject CategoriaService CategoriaService
@inject ILogRepository LogRepository
@inject DialogService DialogService
@inject IClienteRepositoryAsync ClienteRepositoryAsync

<RadzenTemplateForm TItem="Cliente" Data="@cliente" Submit="@OnSubmit">
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Nombre">
            <RadzenTextBox @bind-Value="@cliente.Nombre" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Dirección">
            <RadzenTextBox @bind-Value="@cliente.Direccion" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Email">
            <RadzenTextBox @bind-Value="@cliente.Email" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Teléfono">
            <RadzenTextBox @bind-Value="@cliente.Telefono" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Categoría">
            <RadzenDropDown @bind-Value="@cliente.Categoria"
                            Data="@listaCategorias"
                            TextProperty="Nombre"
                            ValueProperty="Id"
                            Style="width: 100%;"
                            Placeholder="Seleccione una categoría"
                            Name="Categoria" />
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End" Class="rz-mt-4">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Guardar" Icon="save" ButtonStyle="ButtonStyle.Primary" />
            <RadzenButton Text="Cancelar" Click="@(() => DialogService.Close(false))" ButtonStyle="ButtonStyle.Light" />
            @if (EsEdicion)
            {
                <RadzenButton Text="Eliminar" Click="@Delete" Icon="delete" ButtonStyle="ButtonStyle.Danger" />
            }
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Cliente cliente { get; set; } = new Cliente();
    [Parameter] public bool EsEdicion { get; set; } = false;
    private Cliente? clienteOriginal;

    private IEnumerable<Categoria> listaCategorias;

    protected override async Task OnInitializedAsync()
    {
        // Convertimos a carga asíncrona para evitar bloqueos al abrir el diálogo
        listaCategorias = await Task.Run(() => CategoriaService.GetCategorias());

        if (EsEdicion)
        {
            clienteOriginal = new Cliente
            {
                Nombre = cliente.Nombre,
                Direccion = cliente.Direccion,
                Categoria = cliente.Categoria
            };
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            if (EsEdicion)
            {
                // Usamos el nuevo repositorio asíncrono directamente
                await ClienteRepositoryAsync.UpdateClienteAsync(cliente);

                await LogRepository.AddLogAsync(new Log
                {
                    UsuarioId = 1,
                    Entidad = "Cliente",
                    EntidadId = cliente.Id,
                    Accion = "Update (Web)",
                    ValorViejo = $"Nombre: {clienteOriginal?.Nombre}, Cat: {clienteOriginal?.Categoria}",
                    ValorNuevo = $"Nombre: {cliente.Nombre}, Cat: {cliente.Categoria}",
                    Fecha = DateTime.Now
                });
            }
            else
            {
                // Creación asíncrona
                await ClienteRepositoryAsync.AddClienteAsync(cliente);
            }

            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            await DialogService.Alert($"Error al guardar: {ex.Message}");
        }
    }

    private async Task Delete()
    {
        var confirmar = await DialogService.Confirm("¿Eliminar este cliente?", "Confirmar");
        if (confirmar == true)
        {
            // Eliminación asíncrona
            await ClienteRepositoryAsync.DeleteClienteAsync(cliente.Id);

            await LogRepository.AddLogAsync(new Log
            {
                UsuarioId = 1,
                EntidadId = cliente.Id,
                Entidad = "Cliente",
                Accion = "Delete (Web)",
                ValorViejo = cliente.Nombre,
                Fecha = DateTime.Now
            });

            DialogService.Close(true);
        }
    }
}