@using Data.DTOs
@using Data.Modelo
@using Domain.Services
@inject ClienteService ClienteService
@inject CategoriaService CategoriaService
@inject DialogService DialogService

<RadzenTemplateForm TItem="Cliente" Data="@cliente" Submit="@OnSubmit">
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Nombre">
            <RadzenTextBox @bind-Value="@cliente.Nombre" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Dirección">
            <RadzenTextBox @bind-Value="@cliente.Direccion" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Email">
            <RadzenTextBox @bind-Value="@cliente.Email" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Teléfono">
            <RadzenTextBox @bind-Value="@cliente.Telefono" Style="width: 100%;" />
        </RadzenFormField>

        <RadzenFormField Text="Categoría">
            <RadzenDropDown @bind-Value="@cliente.Categoria"
                            Data="@listaCategorias"
                            TextProperty="Nombre"
                            ValueProperty="Id"
                            Style="width: 100%;"
                            Placeholder="Seleccione una categoría"
                            Name="Categoria" />
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End" Class="rz-mt-4">
            <RadzenButton ButtonType="ButtonType.Submit" Text ="Guardar" Icon="save" ButtonStyle="ButtonStyle.Primary" />
            <RadzenButton Text="Cancelar" Click="@(() => DialogService.Close(false))" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton Text="Eliminar" Click="@Delete" Icon="delete" ButtonStyle="ButtonStyle.Danger" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Cliente cliente { get; set; } = new Cliente();
    [Parameter] public bool EsEdicion { get; set; } = false;

    private IEnumerable<Categoria> listaCategorias;

    protected override void OnInitialized()
    {
        listaCategorias = CategoriaService.GetCategorias();
    }

    private async Task OnSubmit()
    {
        try
        {
            if (EsEdicion)
            {
                ClienteService.Repository.UpdateCliente(cliente);
            }
            else
            {
                ClienteService.Repository.AddCliente(cliente);
            }

            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al guardar: {ex.Message}");
        }
    }

    private async Task Delete()
    {
        try
        {
            var confirmar = await DialogService.Confirm("¿Eliminar este cliente?", "Confirmar");
            if (confirmar == true)
            {
                ClienteService.Repository.DeleteCliente(cliente.Id);
                DialogService.Close(true);
            }
        }
        catch (Exception ex)
        {
            await DialogService.Alert("Error al eliminar: " + ex.Message, "Error");
        }
    }
}