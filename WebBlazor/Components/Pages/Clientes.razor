@page "/clientes"
@rendermode InteractiveServer
@using Data.DTOs
@using Data.Modelo
@using Domain.Services
@using WebBlazor.Services
@inject ClienteService ClienteService
@inject CategoriaService CategoriaService
@inject DialogService DialogService
@inject WebBlazor.Services.ExportService ExportService
 
<PageTitle>Clientes</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" Class="rz-m-0">Clientes</RadzenText>
    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
        <RadzenButton Text="@($"Borrar {(selectedClientes?.Count ?? 0)} clientes")"
                      Icon="delete"
                      Size="ButtonSize.Small"
                      ButtonStyle="ButtonStyle.Danger"
                      Click="@EliminarClientesSeleccionados"
                      Disabled="@(selectedClientes == null || !selectedClientes.Any())" />

        <RadzenButton Text="Subir Categoría"
                      Icon="open_in_browser"
                      Size="ButtonSize.Small"
                      Click="@MejoraCategoria"
                      ButtonStyle="ButtonStyle.Secondary"
                      Disabled="@(selectedClientes == null || !selectedClientes.Any())" />

        <RadzenButton Text="Agregar"
                      Icon="add_circle"
                      Size="ButtonSize.Small"
                      Click="@AbrirDialogoAgregar"
                      ButtonStyle="ButtonStyle.Primary" />

    </RadzenStack>

</RadzenStack>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Class="rz-mb-4">
    <RadzenIcon Icon="search" />
    <RadzenTextBox Placeholder="Buscar en todos los campos..." 
                   Style="width: 100%;" 
                   @oninput="@OnSearch" />
</RadzenStack>

<RadzenDataGrid @ref="grid" 
                Data="@clientesFiltrados"
                TItem="ClienteDTO"
                RowSelect="@(args => AbrirDialogoEditar(args.Id))"
                AllowPaging="true"
                PageSize="15"
                AllowSorting="true"
                Style="cursor:pointer">

    <Columns>
        <RadzenDataGridColumn TItem="ClienteDTO" Width="60px" Sortable="false" Filterable="false">
            <HeaderTemplate>
                <RadzenCheckBox TabIndex="-1"
                                TriState="false"
                                TValue="bool?"
                                Value="@(selectedClientes == null || !selectedClientes.Any() ? false : (clientes.Count() == selectedClientes.Count() ? true : (bool?)null))"
                                Change="@(args => selectedClientes = args == true ? clientes.ToList() : null)" />
            </HeaderTemplate>
            <Template Context="data">
                <RadzenCheckBox TabIndex="-1"
                                TriState="false"
                                Value="@(selectedClientes != null && selectedClientes.Contains(data))"
                                TValue="bool"
                                Change="@(args => OnCheckBoxChange(args, data))"
                                @onclick:stopPropagation="true" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Id" Title="ID" Width="70px" TextAlign="TextAlign.Center" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Nombre" Title="Nombre" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Direccion" Title="Dirección" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Email" Title="Email" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Telefono" Title="Teléfono" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="CategoriaNombre" Title="Categoría" />
    </Columns>
</RadzenDataGrid>


<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem;" Class="rz-p-2">
    <RadzenButton Text="Exportar a Excel"
                          Icon="grid_on"
                          Click="@(args => Export("excel"))"
                          ButtonStyle="ButtonStyle.Success" />
    </RadzenStack>

@code
{
    private IEnumerable<ClienteDTO> clientes;
    private IEnumerable<ClienteDTO> clientesFiltrados;
    IList<ClienteDTO> selectedClientes = new List<ClienteDTO>();
    private string textoBusqueda = "";
    bool selectorOn = true;
    RadzenDataGrid<ClienteDTO> grid;


    protected override void OnInitialized()
    {
        CargarDatos();
    }

    private void CargarDatos()
    {
        clientes = ClienteService.GetClientesFiltrados();
        ActualizarFiltro();
    }

    private void OnSearch(ChangeEventArgs args)
    {
        textoBusqueda = args.Value.ToString();
        ActualizarFiltro();
    }

    void OnCheckBoxChange(bool value, ClienteDTO data)
    {
        if (selectedClientes == null) selectedClientes = new List<ClienteDTO>();

        if (value)
            selectedClientes.Add(data);
        else
            selectedClientes.Remove(data);
    }

    private void ActualizarFiltro()
    {
        if (string.IsNullOrWhiteSpace(textoBusqueda))
        {
            clientesFiltrados = clientes;
        }
        else
        {
            var busqueda = textoBusqueda.ToLower();
            clientesFiltrados = clientes.Where(c => 
                (c.Nombre?.ToLower().Contains(busqueda) ?? false) ||
                (c.Direccion?.ToLower().Contains(busqueda) ?? false) ||
                (c.Email?.ToLower().Contains(busqueda) ?? false) ||
                (c.Telefono?.ToLower().Contains(busqueda) ?? false) ||
                (c.CategoriaNombre?.ToLower().Contains(busqueda) ?? false)
            ).ToList();
        }
    }

    private async Task EliminarClientesSeleccionados()
    {
        var confirmar = await DialogService.Confirm(
            $"¿Estás seguro de que deseas eliminar {selectedClientes.Count} clientes?",
            "Eliminar Múltiples");

        if (confirmar == true)
        {
            try
            {
                foreach (var cliente in selectedClientes.ToList())
                {
                    ClienteService.Repository.DeleteCliente(cliente.Id);
                }

                await DialogService.Alert("Proceso finalizado", "Éxito");
            }
            catch (Exception ex)
            {
                await DialogService.Alert($"No se pudieron borrar algunos clientes: {ex.Message}", "Aviso");
            }
            finally
            {
                selectedClientes.Clear();
                CargarDatos();
            }
        }
    }

    private async Task MejoraCategoria()
    {
        var confirmar = await DialogService.Confirm(
            $"¿Estás seguro de que deseas subir de categoría a  {selectedClientes.Count} clientes?",
            "Subir categoría");

        if (confirmar == true)
        {
            foreach (var cliente in selectedClientes)
            {
                var clienteUpdate = ClienteService.Repository.GetCliente(cliente.Id);
                if (clienteUpdate != null)
                {
                    bool cambio = false;

                    if (clienteUpdate.Categoria == 3)
                    {
                        clienteUpdate.Categoria = 1;
                        cambio = true;
                    }
                    else if (clienteUpdate.Categoria == 1)
                    {
                        clienteUpdate.Categoria = 2;
                        cambio = true;
                    }
                    if (cambio)
                    {
                        ClienteService.Repository.UpdateCliente(clienteUpdate);
                    }
                }
            }
            selectedClientes.Clear();
            CargarDatos();
        }
    }

    public void Export(string type)
    {
        var query = new Query()
        {
            OrderBy = grid.Query.OrderBy,
            Filter = grid.Query.Filter
        };

        ExportService.Export("Clientes", type, query);
    }

    private async Task AbrirDialogoAgregar()
    {
        var res = await DialogService.OpenAsync<ClienteDetalle>("Registrar Nuevo Cliente",
            new Dictionary<string, object> {
            { "cliente", new Cliente() }
            });

        if (res == true) CargarDatos();
    }

    private async Task AbrirDialogoEditar(int id)
    {

        var clienteAEditar = ClienteService.Repository.GetCliente(id);

        var res = await DialogService.OpenAsync<ClienteDetalle>($"Editar Cliente #{id}",
            new Dictionary<string, object> {
                { "cliente", clienteAEditar },
                { "EsEdicion", true }
            });

        if (res == true) CargarDatos();
    }
}