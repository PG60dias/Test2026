@page "/clientes"
@using Data.DTOs
@using Data.Modelo
@using Data.Models
@using Data.Repository.Common
@using Domain.Services
@attribute [Authorize]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject ClienteService ClienteService
@inject IClienteRepositoryAsync ClienteRepositoryAsync
@inject DialogService DialogService
@inject NavigationManager Navigation
@inject HttpClient Http
@inject ILogRepository LogRepository
@inject WebBlazor.Services.ExportService ExportService

<PageTitle>Clientes</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" Class="rz-m-0">Clientes</RadzenText>
    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
        <RadzenButton Text="Cerrar Sesión" Icon="logout" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" Variant="Variant.Flat" Click="@ManejarLogout" />
    </RadzenStack>
</RadzenStack>

<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" Class="rz-mb-4">
    <RadzenButton Text="@($"Borrar {(selectedClientes?.Count ?? 0)} clientes")" Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@EliminarClientesSeleccionados" Disabled="@(selectedClientes == null || !selectedClientes.Any())" />
    <RadzenButton Text="Subir Categoría" Icon="update" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Secondary" Click="@MejoraCategoria" Disabled="@(selectedClientes == null || !selectedClientes.Any())" />
    <RadzenButton Text="Agregar" Icon="add_circle" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Click="@AbrirDialogoAgregar" />
</RadzenStack>

<RadzenStack Orientation="Orientation.Horizontal" Class="rz-mb-4">
    <RadzenIcon Icon="search" />
    <RadzenTextBox Placeholder="Buscar por nombre o email..." Style="width: 100%;" @oninput="@OnSearch" />
</RadzenStack>

<RadzenDataGrid @ref="grid" 
                Data="@clientesFiltrados" 
                TItem="ClienteDTO" 
                IsLoading="@isLoading" 
                RowSelect="@(args => AbrirDialogoEditar(args.Id))" 
                AllowPaging="true" 
                ShowPagingSummary="true"
                PageSize="12" 
                AllowSorting="true" 
                Style="cursor:pointer; 
                height: 600px;">
    <Columns>
        <RadzenDataGridColumn TItem="ClienteDTO" Width="60px" Sortable="false" Filterable="false">
            <HeaderTemplate>
                <RadzenCheckBox TabIndex="-1" TriState="false" TValue="bool?" Value="@(selectedClientes == null || !selectedClientes.Any() ? false : (clientes?.Count() == selectedClientes.Count() ? true : (bool?)null))" Change="@(args => selectedClientes = args == true ? clientes?.ToList() ?? new List<ClienteDTO>() : new List<ClienteDTO>())" />
            </HeaderTemplate>
            <Template Context="data">
                <RadzenCheckBox TabIndex="-1" TriState="false" Value="@(selectedClientes != null && selectedClientes.Contains(data))" TValue="bool" Change="@(args => OnCheckBoxChange(args, data))" @onclick:stopPropagation="true" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Id" Title="ID" Width="70px" TextAlign="TextAlign.Center" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Nombre" Title="Nombre" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Direccion" Title="Dirección" /> @* Corregido: Columna añadida *@
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Email" Title="Email" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="Telefono" Title="Teléfono" />
        <RadzenDataGridColumn TItem="ClienteDTO" Property="CategoriaNombre" Title="Categoría" />
    </Columns>
</RadzenDataGrid>

@code {
    private IEnumerable<ClienteDTO>? clientes;
    private IEnumerable<ClienteDTO>? clientesFiltrados;
    private IList<ClienteDTO> selectedClientes = new List<ClienteDTO>();
    private string textoBusqueda = "";
    private bool isLoading = true;
    private RadzenDataGrid<ClienteDTO> grid;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosAsync();
    }

    private async Task CargarDatosAsync()
    {
        isLoading = true;
        try
        {
            clientes = await ClienteService.GetClientesFiltradosWebAsync();
            ActualizarFiltro();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnSearch(ChangeEventArgs args)
    {
        textoBusqueda = args.Value?.ToString() ?? "";
        ActualizarFiltro();
    }

    private void ActualizarFiltro()
    {
        if (string.IsNullOrWhiteSpace(textoBusqueda))
        {
            clientesFiltrados = clientes?.ToList();
        }
        else
        {
            var b = textoBusqueda.ToLower();
            clientesFiltrados = clientes?.Where(c =>
                (c.Id.ToString().Contains(b, StringComparison.OrdinalIgnoreCase) == true) ||
                (c.Nombre?.Contains(b, StringComparison.OrdinalIgnoreCase) == true) ||
                (c.Email?.Contains(b, StringComparison.OrdinalIgnoreCase) == true) ||
                (c.Direccion?.Contains(b, StringComparison.OrdinalIgnoreCase) == true) ||
                (c.Telefono.Contains(b, StringComparison.OrdinalIgnoreCase) == true) ||
                (c.CategoriaNombre.Contains(b, StringComparison.OrdinalIgnoreCase) == true)
            ).ToList();
        }
    }

    private void OnCheckBoxChange(bool value, ClienteDTO data)
    {
        if (value) selectedClientes.Add(data);
        else selectedClientes.Remove(data);
    }

    private async Task AbrirDialogoEditar(int id)
    {
        isLoading = true;
        var clienteAEditar = await ClienteRepositoryAsync.GetClienteAsync(id);
        isLoading = false;

        var resultado = await DialogService.OpenAsync<ClienteDetalle>($"Editar Cliente #{id}",
            new Dictionary<string, object> {
                { "cliente", clienteAEditar },
                { "EsEdicion", true }
            });

        if (resultado == true) await CargarDatosAsync();
    }

    private async Task AbrirDialogoAgregar()
    {
        var resultado = await DialogService.OpenAsync<ClienteDetalle>("Nuevo Cliente",
            new Dictionary<string, object> {
                { "cliente", new Cliente() },
                { "EsEdicion", false }
            });

        if (resultado == true) await CargarDatosAsync();
    }

    private async Task EliminarClientesSeleccionados()
    {
        var confirm = await DialogService.Confirm($"¿Eliminar {selectedClientes.Count} clientes?", "Eliminar");
        if (confirm == true)
        {
            isLoading = true;
            foreach (var item in selectedClientes.ToList())
            {
                await ClienteRepositoryAsync.DeleteClienteAsync(item.Id);
            }
            selectedClientes.Clear();
            await CargarDatosAsync();
        }
    }

    private async Task MejoraCategoria()
    {
        foreach (var dto in selectedClientes)
        {
            var cliente = await ClienteRepositoryAsync.GetClienteAsync(dto.Id);
            if (cliente != null)
            {
                cliente.Categoria = cliente.Categoria + 1;
                await ClienteRepositoryAsync.UpdateClienteAsync(cliente);
            }
        }
        await CargarDatosAsync();
    }

    private async Task ManejarLogout()
    {
        await Http.PostAsync("api/auth/logout", null);
        Navigation.NavigateTo("/", forceLoad: true);
    }
}